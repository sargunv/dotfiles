starship:
  preset: pure-preset
  config:
    format: $username$hostname$directory$git_branch${custom.av}${custom.graphite}$git_state$git_status$cmd_duration$line_break$character
    right_format: "$time"
    command_timeout: 1000
    time:
      disabled: false
      style: dimmed
    directory:
      truncate_to_repo: false
    custom:
      av:
        command: |
          current_branch=$(git branch --show-current 2>/dev/null) || exit 1
          jq -r --arg branch "$current_branch" '
            if .branches[$branch] and .branches[$branch].pullRequest.number then
              "\u001B]8;;" +
              .branches[$branch].pullRequest.permalink +
              "\u001B\\#" +
              (.branches[$branch].pullRequest.number | tostring) +
              "\u001B]8;;\u001B\\"
            else
              empty
            end
          ' .git/av/av.db 2>/dev/null || exit 1
        format: " [$output]($style)"
        style: dimmed
        when: "[ -f .git/av/av.db ]"
      graphite:
        command: |
          current_branch=$(git branch --show-current 2>/dev/null) || exit 1
          jq -r --arg branch "$current_branch" '
            .prInfos[]
            | select(.headRefName == $branch)
            | . as $pr
            | ($pr.url | capture("https://app.graphite.dev/github/pr/(?<owner>[^/]+)/(?<repo>[^/]+)/(?<pr>[0-9]+)") ) as $url
            | (if $pr.state == "OPEN" then "\u001B[1m\u001B[32m\u001B[0m"
               elif $pr.state == "MERGED" then "\u001B[1m\u001B[35m\u001B[0m"
               elif $pr.state == "CLOSED" then "\u001B[1m\u001B[31m\u001B[0m"
               elif $pr.state == "DRAFT" then "\u001B[1m\u001B[33m\u001B[0m"
               else "\u001B[1m\u001B[2m" + $pr.state + "\u001B[0m" end) as $icon
            | (
                "\u001B]8;;https://github.com/" + $url.owner + "/" + $url.repo + "/pull/" + $url.pr +
                "\u001B\\#" + $url.pr + " " + $icon + "\u001B]8;;\u001B\\"
              )
          ' .git/.graphite_pr_info 2>/dev/null || exit 1
        format: " [$output]($style)"
        style: dimmed
        when: "[ -f .git/.graphite_pr_info ]"
